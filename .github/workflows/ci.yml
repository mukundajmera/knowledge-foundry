# ═══════════════════════════════════════════════════════════
# Knowledge Foundry — CI/CD Pipeline
# Lint → Test → RAGAS → Security → Build → Deploy
# ═══════════════════════════════════════════════════════════

name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"

jobs:
  # ─── Backend Lint ───
  lint:
    name: Lint (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install ruff mypy
          pip install -e ".[dev]" 2>/dev/null || pip install -e .

      - name: Ruff check
        run: ruff check src/ tests/
        continue-on-error: true

      - name: Mypy type check
        run: mypy src/ --ignore-missing-imports --no-error-summary || true

  # ─── Backend Tests ───
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          pip install -e ".[dev]" 2>/dev/null || pip install -e .
          pip install pytest pytest-cov pytest-asyncio

      - name: Run tests with coverage
        run: |
          python -m pytest tests/unit/ \
            -v \
            --cov=src \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=76

      - name: Upload coverage
        if: matrix.python-version == '3.12'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  # ─── RAGAS Quality Gate ───
  ragas:
    name: RAGAS Evaluation
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -e ".[dev]" 2>/dev/null || pip install -e .
          pip install pytest

      - name: Run RAGAS evaluation suite
        run: |
          python -m pytest tests/evaluation/test_ragas.py \
            -v \
            --tb=short \
            -x

      - name: Verify golden dataset integrity
        run: |
          python -c "
          import json
          from pathlib import Path
          data = json.loads(Path('tests/evaluation/golden_dataset.json').read_text())
          questions = data['questions']
          assert len(questions) >= 20, f'Golden dataset too small: {len(questions)}'
          categories = {q['category'] for q in questions}
          assert len(categories) >= 4, f'Not enough categories: {categories}'
          print(f'✅ Golden dataset OK: {len(questions)} questions, {len(categories)} categories')
          "

  # ─── Security Scan ───
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install security tools
        run: pip install bandit safety

      - name: Bandit — static analysis
        run: bandit -r src/ -ll --format json -o bandit-report.json || true

      - name: Bandit — summary
        run: bandit -r src/ -ll --format screen || true

      - name: Safety — dependency vulnerabilities
        run: safety check --output json > safety-report.json 2>/dev/null || true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  # ─── Frontend Build + E2E ───
  frontend:
    name: Frontend (Build + E2E)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Type check + Build
        run: npm run build

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        run: npx playwright test --reporter=github

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/test-results/

  # ─── Docker Build ───
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [lint, test, ragas, security, frontend]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API image
        run: |
          docker build -t knowledge-foundry-api:${{ github.sha }} .
          docker build -t knowledge-foundry-api:latest .

      - name: Build Frontend image
        run: |
          docker build -t knowledge-foundry-frontend:${{ github.sha }} ./frontend
          docker build -t knowledge-foundry-frontend:latest ./frontend

      - name: Verify images
        run: |
          docker images | grep knowledge-foundry

  # ─── Staging Smoke Test ───
  staging:
    name: Staging Deploy + Smoke Test
    runs-on: ubuntu-latest
    needs: [docker]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Start services via Docker Compose
        run: |
          docker compose up -d --build api
          echo "Waiting for API to become healthy..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8000/health > /dev/null 2>&1; then
              echo "✅ API is healthy"
              break
            fi
            echo "  Waiting... ($i/30)"
            sleep 2
          done

      - name: Smoke test — /health
        run: |
          STATUS=$(curl -sf http://localhost:8000/health | python3 -c "import sys,json; print(json.load(sys.stdin)['status'])")
          [ "$STATUS" = "ok" ] && echo "✅ Health OK" || (echo "❌ Health failed: $STATUS" && exit 1)

      - name: Smoke test — /ready
        run: |
          curl -sf http://localhost:8000/ready | python3 -m json.tool
          echo "✅ Ready endpoint responding"

      - name: Smoke test — /compliance/health
        run: |
          curl -sf http://localhost:8000/compliance/health | python3 -m json.tool || echo "⚠️ Compliance endpoint not available (expected during staging)"

      - name: Tear down
        if: always()
        run: docker compose down -v
